function e(e,t={},n=""){const a=document.createElement(e);for(const[i,l]of Object.entries(t))"className"===i?a.className=l:i.startsWith("data-")?a.setAttribute(i,l):"style"===i&&"object"==typeof l?Object.assign(a.style,l):a.setAttribute(i,String(l));return n&&(a.textContent=n),a}function t(){if(!lastAppointmentData)return alert("Randevu bilgileri bulunamadı. Lütfen tekrar deneyin."),void ModalUtils.close("calendarModal");const e=function(){const e=navigator.userAgent,t=navigator.platform||"",n={ios:/iPhone|iPad|iPod/.test(e)&&!window.MSStream,android:/Android/.test(e),macos:/Mac/.test(t)&&!/iPhone|iPad|iPod/.test(e),windows:/Win/.test(t),safari:/Safari/.test(e)&&!/Chrome|CriOS/.test(e),chrome:/Chrome|CriOS/.test(e),firefox:/Firefox|FxiOS/.test(e),edge:/Edg/.test(e),mobile:/iPhone|iPad|iPod|Android/.test(e)};return n}(),t=new Date(lastAppointmentData.date+"T"+lastAppointmentData.time),i=lastAppointmentData.duration||CONFIG.APPOINTMENT_HOURS.interval||60,l=new Date(t.getTime()+6e4*i),o=n(t,l);if((e.ios||e.macos)&&e.safari){const e=`data:text/calendar;base64,${btoa(unescape(encodeURIComponent(o)))}`;window.location.href=e,ModalUtils.close("calendarModal"),a("Apple Calendar açılıyor...","success")}else{const e=new Blob([o],{type:"text/calendar;charset=utf-8"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="rolex-randevu.ics",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),ModalUtils.close("calendarModal"),a("ICS dosyası indirildi","success")}}function n(e,t){let n="RANDEVU BİLGİLERİ\\n\\n",a="Rolex Randevu",i="-PT30M";if(lastAppointmentData){const e={delivery:"Saat Takdimi",consultation:"Genel Görüşme"}[lastAppointmentData.appointmentType]||CONFIG.APPOINTMENT_TYPES?.find(e=>e.value===lastAppointmentData.appointmentType)?.name||"Genel";a=`İzmir İstinyepark Rolex - ${lastAppointmentData.staffName} (${e})`;const t=new Date(lastAppointmentData.date);i=`VALUE=DATE-TIME:${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}T070000Z`,n+=`İlgili: ${lastAppointmentData.staffName}\\n`,n+=`İletişim: ${lastAppointmentData.staffPhone||"Belirtilmedi"}\\n`,n+=`E-posta: ${lastAppointmentData.staffEmail||"Belirtilmedi"}\\n`;const l={year:"numeric",month:"long",day:"numeric"};n+=`Tarih: ${t.toLocaleDateString("tr-TR",l)}\\n`,n+=`Saat: ${lastAppointmentData.time}\\n`,n+=`Konu: ${e}\\n`,lastAppointmentData.customerNote&&(n+=`Ek Bilgi: ${lastAppointmentData.customerNote}\\n`),n+="\\nRandevunuza zamanında gelmenizi rica ederiz.\\nLütfen kimlik belgenizi yanınızda bulundurun."}else n="Randevunuz onaylandı";return["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Rolex İzmir İstinyepark//Randevu Sistemi//TR","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VTIMEZONE","TZID:Europe/Istanbul","BEGIN:STANDARD","DTSTART:19701025T040000","RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10","TZOFFSETFROM:+0300","TZOFFSETTO:+0300","TZNAME:+03","END:STANDARD","END:VTIMEZONE","BEGIN:VEVENT",`UID:rolex-${Date.now()}@istinyepark.com`,`DTSTAMP:${DateUtils.toICSDate(new Date)}Z`,`DTSTART;TZID=Europe/Istanbul:${DateUtils.toICSDate(e)}`,`DTEND;TZID=Europe/Istanbul:${DateUtils.toICSDate(t)}`,`SUMMARY:${a}`,`DESCRIPTION:${n}`,"LOCATION:Rolex İzmir İstinyepark","STATUS:CONFIRMED","ORGANIZER;CN=Rolex İzmir İstinyepark:mailto:istinyeparkrolex35@gmail.com","BEGIN:VALARM",`TRIGGER;${i}`,"ACTION:DISPLAY","DESCRIPTION:Randevunuza zamanında gelmenizi rica ederiz. Lütfen kimlik belgenizi yanınızda bulundurun.","END:VALARM","END:VEVENT","END:VCALENDAR"].join("\r\n")}function a(e,t="success"){const n=document.querySelector(".toast");n&&n.remove();const a=document.createElement("div");a.className=`toast ${t}`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>a.remove(),500)},3e3)}"undefined"!=typeof window&&(window.escapeHtml=function(e){if(null==e)return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,e=>t[e])},window.createElement=e,window.showAlertSafe=function(t,n="info",a="alertContainer"){const i=document.getElementById(a);if(!i)return;i.textContent="";const l=e("div",{className:`alert alert-${n}`},t);i.appendChild(l),setTimeout(()=>{i.textContent=""},4e3)},window.renderListSafe=function(e,t,n){e&&(e.textContent="",t.forEach(t=>{const a=n(t);a&&e.appendChild(a)}))},window.createSafeFragment=function(e){const t=document.createElement("template");return t.innerHTML=e,t.content},window.createLoadingElement=function(t="Yükleniyor..."){const n=e("div",{style:{textAlign:"center",padding:"20px"}}),a=e("div",{className:"spinner"}),i=e("p",{},t);return n.appendChild(a),n.appendChild(i),n},window.createTableRow=function(t,n=!1){const a=e("tr"),i=n?"th":"td";return t.forEach(t=>{const n=e(i);if("string"==typeof t)n.textContent=t;else if(t instanceof Element)n.appendChild(t);else if(t&&"object"==typeof t){const{text:e,html:a,element:i,...l}=t;Object.entries(l).forEach(([e,t])=>{n.setAttribute(e,t)}),e?n.textContent=e:i&&n.appendChild(i)}a.appendChild(n)}),a},window.createSuccessPageSafe=function(t,n,a,i){const l=new Date(t),o=DateUtils.toTurkishDate(l),s=document.createElement("div"),d=e("div",{className:"header"}),r=e("img",{src:"assets/rolex-logo.svg",className:"rolex-logo",alt:"Rolex Logo"});d.appendChild(r);const c=e("h2",{style:{margin:"20px 0 2px",fontSize:"14px",fontWeight:"normal",letterSpacing:"1px",textAlign:"center",color:"#757575",fontFamily:"'Montserrat', sans-serif"}},"Rolex İzmir İstinyepark");d.appendChild(c);const m=e("p",{style:{margin:"5px 0 0",fontSize:"12px",color:"#666",textAlign:"center",fontFamily:"'Montserrat', sans-serif",textTransform:"capitalize"}},a);d.appendChild(m);const u=e("div",{className:"success-container"}),p=e("div",{className:"success-icon"},"✓"),y=e("div",{className:"success-title"},"Randevunuz Oluşturuldu"),g=e("p",{className:"success-text"},"Sizi mağazamızda ağırlamayı sabırsızlıkla bekliyoruz.");u.appendChild(p),u.appendChild(y),u.appendChild(g);const f=e("div",{className:"appointment-details"}),E=e("div",{className:"details-header"},"Randevu Bilgileriniz");f.appendChild(E);const v=e("div",{className:"detail-item"},o),S=e("div",{className:"detail-item"},`Saat ${n}`),h=e("div",{className:"detail-item"},`İlgili: ${a}`);if(f.appendChild(v),f.appendChild(S),f.appendChild(h),i){const t=e("div",{className:"detail-item"},`Not: ${i}`);f.appendChild(t)}const I=e("div",{className:"detail-location"},"Rolex İzmir İstinyepark");f.appendChild(I),u.appendChild(f);const D=e("button",{className:"btn-secondary",id:"addToCalendarBtn"},"Takvime Ekle");return u.appendChild(D),s.appendChild(d),s.appendChild(u),s});const i={APPS_SCRIPT_URL:"https://script.google.com/macros/s/AKfycbwmowzsBLrAOjn-HVtw_LSLf-Gn0jrWdaQMrxaJeulqnhJCQduyyeSvctsWPAXxSAuo/exec",BASE_URL:"https://rolexizmiristinyepark.github.io/randevu_app/",DEBUG:!1,SHIFTS:{morning:{start:10,end:18,label:"Sabah (10:00-18:00)"},evening:{start:14,end:22,label:"Aksam (14:00-22:00)"},full:{start:10,end:22,label:"Full (10:00-22:00)"}},APPOINTMENT_HOURS:{earliest:11,latest:21,interval:60},MAX_DAILY_DELIVERY_APPOINTMENTS:4,APPOINTMENT_TYPES:[{value:"delivery",name:"Saat Teslim Alma"},{value:"service",name:"Servis & Bakım"},{value:"consultation",name:"Ürün Danışmanlığı"},{value:"general",name:"Genel Görüşme"}]},l=(...e)=>i.DEBUG,o={open(e){document.getElementById(e)?.classList.add("active")},close(e){document.getElementById(e)?.classList.remove("active")},toggle(e){document.getElementById(e)?.classList.toggle("active")}};let s=new Date,d=null,r=null,c=null,m=null,u=null,p=[],y={},g={},f={},E=null,v=null;"undefined"!=typeof window&&(window.lastAppointmentData=null);const S=3e5,h="rolex_cache_",I={get(e){try{const t=sessionStorage.getItem(h+e);return t?JSON.parse(t):void 0}catch(t){return}},set(e,t){try{sessionStorage.setItem(h+e,JSON.stringify(t))}catch(n){this.clear()}},has:e=>null!==sessionStorage.getItem(h+e),delete(e){sessionStorage.removeItem(h+e)},clear(){Object.keys(sessionStorage).forEach(e=>{e.startsWith(h)&&sessionStorage.removeItem(e)})}};function D(e){u=e;const t=document.querySelector(".type-card.selected");t&&t.classList.remove("selected"),document.querySelector(`.type-card[data-type="${e}"]`).classList.add("selected"),document.getElementById("calendarSection").style.display="block",A(),B()}async function T(e){s.setMonth(s.getMonth()+e);const t=`${s.toISOString().slice(0,7)}_${E||"all"}`;if(I.has(t)){const e=I.get(t);if(Date.now()-e.timestamp<S)return y=e.data.dayShifts||{},g=e.data.allAppointments||{},f=e.data.googleCalendarEvents||{},void A()}A(),await B()}function A(){const e=document.getElementById("calendarGrid");document.getElementById("currentMonth").textContent=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"][s.getMonth()]+" "+s.getFullYear(),e.innerHTML="";const t=document.createDocumentFragment();["Pzt","Sal","Çar","Per","Cum","Cmt","Paz"].forEach(e=>{const n=document.createElement("div");n.className="day-header",n.textContent=e,t.appendChild(n)});let n=new Date(s.getFullYear(),s.getMonth(),1).getDay();n=0===n?6:n-1;for(let l=0;l<n;l++){const e=document.createElement("div");e.className="calendar-day other-month",t.appendChild(e)}const a=new Date(s.getFullYear(),s.getMonth()+1,0).getDate(),i=new Date;i.setHours(0,0,0,0);for(let l=1;l<=a;l++){const e=document.createElement("div");e.className="calendar-day",e.textContent=l;const n=new Date(s.getFullYear(),s.getMonth(),l);n.setHours(0,0,0,0);const a=DateUtils.toLocalDate(n);if(e.setAttribute("data-date",a),n<=i)e.classList.add("past");else{const t=N(a);t.available?(e.classList.add("available"),e.onclick=()=>C(a)):(e.classList.add("unavailable"),e.title=t.reason||"Müsait değil")}t.appendChild(e)}e.appendChild(t)}function N(e){if("management"===u)return{available:!0};if(E){if(!(y[e]&&y[e][E]))return{available:!1,reason:"İlgili çalışan bu gün müsait değil"}}else{if(!(y[e]&&Object.keys(y[e]).length>0))return{available:!1,reason:"Çalışan yok"}}const t=f[e]||[],n=new Date,a=DateUtils.toLocalDate(n);let l=t.filter(t=>{if("delivery"!==t.extendedProperties?.private?.appointmentType)return!1;if(e===a&&t.start){if((t.start.time||(()=>{const e=new Date(t.start.dateTime);return String(e.getHours()).padStart(2,"0")+":"+String(e.getMinutes()).padStart(2,"0")})())<String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0"))return!1}return!0}).length;return"delivery"===u&&l>=i.MAX_DAILY_DELIVERY_APPOINTMENTS?{available:!1,reason:"Teslim randevuları dolu (Max 4)"}:{available:!0}}function C(e){d=e;const t=document.querySelector(".calendar-day.selected");t&&t.classList.remove("selected");const n=document.querySelector(`.calendar-day[data-date="${e}"]`);if(n&&n.classList.add("selected"),"0"===E&&"management"===u)r=0,m="full",R(),document.getElementById("timeSection").style.display="block",document.getElementById("staffSection").style.display="none",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none";else if(E)if("0"!==E){r=parseInt(E);const t=y[e]?.[parseInt(E)];t&&(m=t,R(),document.getElementById("timeSection").style.display="block",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none")}else m="full",R(),document.getElementById("timeSection").style.display="block",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none";else!function(){const e=document.getElementById("staffList");if(e.innerHTML="",0===p.length){const t=createElement("div",{style:{gridColumn:"1/-1",textAlign:"center",padding:"40px"}}),n=createElement("div",{className:"spinner",style:{margin:"0 auto 20px"}}),a=createElement("button",{className:"btn",style:{padding:"12px 30px"}},"Yenile");return a.addEventListener("click",()=>location.reload()),t.appendChild(n),t.appendChild(a),void e.appendChild(t)}const t=y[d]||{};p.forEach(n=>{if(!n.active)return;const a=t[n.id],i=!!a,l=document.createElement("div");l.className="staff-card"+(i?"":" unavailable");const o=createElement("div",{className:"staff-name"},n.name);l.appendChild(o),i?l.addEventListener("click",e=>function(e,t,n){r=parseInt(e),m=t;const a=p.find(t=>t.id===parseInt(e));if(a){const e=document.getElementById("staffHeader");e.textContent=a.name,e.style.visibility="visible"}const i=document.querySelector(".staff-card.selected");i&&i.classList.remove("selected");n&&n.currentTarget&&n.currentTarget.classList.add("selected");R(),document.getElementById("timeSection").style.display="block",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none"}(n.id,a,e)):(l.style.opacity="0.5",l.style.cursor="not-allowed"),e.appendChild(l)})}(),document.getElementById("staffSection").style.display="block",document.getElementById("timeSection").style.display="none",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none"}function b(){const e=document.getElementById("staffList");e.innerHTML="";[{id:"HK",name:"HK"},{id:"OK",name:"OK"}].forEach(t=>{const n=document.createElement("div");n.className="staff-card";const a=createElement("div",{className:"staff-name"},t.name);n.appendChild(a),n.addEventListener("click",e=>function(e,t){r=0,window.managementContactPerson=e.name;const n=document.getElementById("staffHeader");n.textContent=`Yönetim - ${e.name}`,n.style.visibility="visible";const a=document.querySelector(".staff-card.selected");a&&a.classList.remove("selected");t&&t.currentTarget&&t.currentTarget.classList.add("selected");document.getElementById("staffSection").style.display="none",document.getElementById("detailsSection").style.display="block",document.getElementById("submitBtn").style.display="block"}(t,e)),e.appendChild(n)})}async function B(){const e=new Date(s.getFullYear(),s.getMonth(),1),t=new Date(s.getFullYear(),s.getMonth()+1,0),n=s.toISOString().slice(0,7),a=`${n}_${E||"all"}`;if(I.has(a)){const e=I.get(a);if(Date.now()-e.timestamp<S)return y=e.data.dayShifts||{},g=e.data.allAppointments||{},f=e.data.googleCalendarEvents||{},void A()}!function(){const e=document.getElementById("alertContainer");if(!e)return;e.textContent="";const t=createElement("div",{className:"loading"}),n=createElement("div",{className:"spinner"});t.appendChild(n),e.appendChild(t)}();try{const[i,l,o]=await Promise.all([L("getMonthShifts",{month:n}),L("getMonthAppointments",{month:n}),L("getGoogleCalendarEvents",{startDate:DateUtils.toLocalDate(e),endDate:DateUtils.toLocalDate(t),staffId:E||"all"})]);i.success&&(y=i.data||{}),l.success&&(g=l.data||{}),o.success&&(f=o.data||{}),I.set(a,{timestamp:Date.now(),data:{dayShifts:{...y},allAppointments:{...g},googleCalendarEvents:{...f}}}),A(),function(){const e=document.getElementById("alertContainer");e&&(e.textContent="")}()}catch(i){!function(){const e=document.querySelector(".container");e.textContent="";const t=createElement("div",{className:"header"}),n=createElement("img",{src:"assets/rolex-logo.svg",className:"rolex-logo",alt:"Rolex Logo"});t.appendChild(n);const a=createElement("h2",{style:{margin:"20px 0 2px",fontSize:"14px",fontWeight:"normal",letterSpacing:"1px",textAlign:"center",color:"#757575",fontFamily:"'Montserrat', sans-serif"}},"Rolex İzmir İstinyepark");t.appendChild(a);const i=createElement("div",{className:"loading-error-container"}),l=createElement("div",{className:"spinner"}),o=createElement("button",{className:"btn",id:"reloadBtn",style:{marginTop:"40px",padding:"12px 30px"}},"Yeniden Dene");i.appendChild(l),i.appendChild(o),e.appendChild(t),e.appendChild(i),setTimeout(()=>{const e=document.getElementById("reloadBtn");e&&e.addEventListener("click",()=>location.reload())},0)}()}}function L(e,t={}){return new Promise(async(n,a)=>{try{const a={...t,action:e},l=i.APPS_SCRIPT_URL+"?"+new URLSearchParams(a).toString(),o=new AbortController,s=setTimeout(()=>o.abort(),3e4),d=await fetch(l,{method:"GET",mode:"cors",credentials:"omit",signal:o.signal,headers:{Accept:"application/json"}});if(clearTimeout(s),!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const r=await d.json();if(!r||"object"!=typeof r)throw new Error("Geçersiz API yanıtı");n(r)}catch(l){"AbortError"===l.name?a(new Error("Timeout - API cevap vermedi")):l.message.includes("Failed to fetch")?a(new Error("API bağlantısı kurulamadı. CORS veya ağ hatası.")):a(l)}})}async function w(){try{const e=await L("getStaff");e.success?p=e.data:l("Calisanlar yuklenemedi:",e.error)}catch(e){}}function R(){const e=document.getElementById("timeSlots");e.innerHTML="";const t=new Date,n=DateUtils.toLocalDate(t),a=d===n;if("management"===u){const{earliest:t,latest:n,interval:a}=i.APPOINTMENT_HOURS;for(let i=t;i<n;i++)for(let t=0;t<60;t+=a){const n=String(i).padStart(2,"0")+":"+String(t).padStart(2,"0"),a=document.createElement("div");a.className="slot-btn",a.textContent=n,a.addEventListener("click",()=>M(n,a)),e.appendChild(a)}return}const l=f[d]||[],o={};l.forEach(e=>{if(!e.start)return;const t=e.start.time||(()=>{const t=new Date(e.start.dateTime);return String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")})();o[t]||(o[t]=[]),o[t].push(e)});let s=l.filter(e=>{if("delivery"!==e.extendedProperties?.private?.appointmentType)return!1;if(a&&e.start?.dateTime){if(new Date(e.start.dateTime)<t)return!1}return!0}).length;if("delivery"===u&&s>=i.MAX_DAILY_DELIVERY_APPOINTMENTS)return void(e.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #dc3545;">Bu gun icin teslim randevulari dolu (Max 4).</div>');const c=i.SHIFTS[m];if(!c)return;const{earliest:p,latest:y,interval:E}=i.APPOINTMENT_HOURS,v=Math.max(c.start,p),S=Math.min(c.end,y),h=g[d]||[],I={};h.forEach(e=>{if(!e.start)return;const t=e.start.time||(()=>{const t=new Date(e.start.dateTime);return String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")})();I[t]||(I[t]=[]),I[t].push(e)});for(let i=v;i<S;i++)for(let n=0;n<60;n+=E){const l=String(i).padStart(2,"0")+":"+String(n).padStart(2,"0");let s=!1;if(a){const e=new Date(t);e.setHours(i,n,0,0),s=e<t}const d=(I[l]||[]).some(e=>parseInt(e.extendedProperties?.private?.staffId)===r),c=o[l]||[];let m=!1;m=c.length>=2||c.some(e=>{const t=e.extendedProperties?.private?.staffId,n=e.extendedProperties?.private?.appointmentType;return"delivery"===u&&"delivery"===n||(!t||t===String(r))});const p=d||m||s,y=document.createElement("div");y.className="slot-btn"+(p?" disabled":""),y.textContent=l,p&&(y.title="Bu saat dolu"),p||y.addEventListener("click",()=>M(l,y)),e.appendChild(y)}}function M(e,t){c=e;const n=document.querySelector(".slot-btn.selected");n&&n.classList.remove("selected"),t.classList.add("selected"),"management"===u?(b(),document.getElementById("staffSection").style.display="block",document.getElementById("detailsSection").style.display="none",document.getElementById("submitBtn").style.display="none"):(document.getElementById("detailsSection").style.display="block",document.getElementById("submitBtn").style.display="block")}function P(e,t){showAlertSafe(e,t,"alertContainer")}function x(e){const i=e.target.id;try{switch(i){case"calendarAppleBtn":t();break;case"calendarGoogleBtn":!function(){if(!lastAppointmentData)return void alert("Randevu bilgileri bulunamadı. Lütfen tekrar deneyin.");const e=new Date(lastAppointmentData.date+"T"+lastAppointmentData.time),t=lastAppointmentData.duration||CONFIG.APPOINTMENT_HOURS.interval||60,n=new Date(e.getTime()+6e4*t),i=e=>e.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",l=i(e),o=i(n);let s="RANDEVU BİLGİLERİ\n\n";s+=`Müşteri: ${lastAppointmentData.customerName}\n`,s+=`İletişim: ${lastAppointmentData.customerPhone}\n`,lastAppointmentData.customerEmail&&(s+=`E-posta: ${lastAppointmentData.customerEmail}\n`),s+=`Tarih: ${new Date(lastAppointmentData.date).toLocaleDateString("tr-TR",{year:"numeric",month:"long",day:"numeric"})}\n`,s+=`Saat: ${lastAppointmentData.time}\n`,s+=`Konu: ${CONFIG.APPOINTMENT_TYPES?.find(e=>e.value===lastAppointmentData.appointmentType)?.name||"Genel"}\n`,s+=`İlgili: ${lastAppointmentData.staffName}\n`,lastAppointmentData.customerNote&&(s+=`Ek Bilgi: ${lastAppointmentData.customerNote}\n`);const d=`${lastAppointmentData.customerName} - ${lastAppointmentData.staffName}`,r=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(d)}&dates=${l}/${o}&details=${encodeURIComponent(s)}&location=${encodeURIComponent("Rolex İzmir İstinyepark")}`;window.open(r,"_blank"),ModalUtils.close("calendarModal"),a("Google Calendar açıldı","success")}();break;case"calendarOutlookBtn":!function(){if(!lastAppointmentData)return void alert("Randevu bilgileri bulunamadı. Lütfen tekrar deneyin.");const e=new Date(lastAppointmentData.date+"T"+lastAppointmentData.time),t=lastAppointmentData.duration||CONFIG.APPOINTMENT_HOURS.interval||60,n=new Date(e.getTime()+6e4*t);let i="RANDEVU BİLGİLERİ<br><br>";i+=`Müşteri: ${lastAppointmentData.customerName}<br>`,i+=`İletişim: ${lastAppointmentData.customerPhone}<br>`,lastAppointmentData.customerEmail&&(i+=`E-posta: ${lastAppointmentData.customerEmail}<br>`),i+=`Tarih: ${lastAppointmentData.date}<br>`,i+=`Saat: ${lastAppointmentData.time}<br>`,i+=`Konu: ${CONFIG.APPOINTMENT_TYPES?.find(e=>e.value===lastAppointmentData.appointmentType)?.name||"Genel"}<br>`,i+=`İlgili: ${lastAppointmentData.staffName}<br>`,lastAppointmentData.customerNote&&(i+=`Ek Bilgi: ${lastAppointmentData.customerNote}<br>`);const l=`${lastAppointmentData.customerName} - ${lastAppointmentData.staffName}`,o=new URL("https://outlook.live.com/calendar/0/deeplink/compose");o.searchParams.append("path","/calendar/action/compose"),o.searchParams.append("rru","addevent"),o.searchParams.append("startdt",e.toISOString()),o.searchParams.append("enddt",n.toISOString()),o.searchParams.append("subject",l),o.searchParams.append("location","Rolex İzmir İstinyepark"),o.searchParams.append("body",i),window.open(o.toString(),"_blank"),ModalUtils.close("calendarModal"),a("Outlook Calendar açıldı","success")}();break;case"calendarICSBtn":!function(){if(!lastAppointmentData)return alert("Randevu bilgileri bulunamadı. Lütfen tekrar deneyin."),void ModalUtils.close("calendarModal");const e=new Date(lastAppointmentData.date+"T"+lastAppointmentData.time),t=lastAppointmentData.duration||CONFIG.APPOINTMENT_HOURS.interval||60,i=new Date(e.getTime()+6e4*t),l=n(e,i),o=new Blob([l],{type:"text/calendar;charset=utf-8"}),s=URL.createObjectURL(o),d=document.createElement("a");d.href=s,d.download="rolex-randevu.ics",document.body.appendChild(d),d.click(),setTimeout(()=>{document.body.removeChild(d),URL.revokeObjectURL(s),ModalUtils.close("calendarModal"),a("Takvim dosyası (.ics) indirildi","success")},100)}()}}catch(l){alert("Takvim ekleme özelliği şu anda kullanılamıyor. Lütfen daha sonra tekrar deneyin.")}}function k(){o.open("calendarModal")}document.addEventListener("DOMContentLoaded",async function(){const e=new URLSearchParams(window.location.search);if(E=e.get("staff"),"0"===E){const e=document.getElementById("staffHeader");e.textContent="Yönetim Randevuları",e.style.visibility="visible",r=0,document.getElementById("typeManagement").style.display="block";document.getElementById("appointmentTypesContainer").style.gridTemplateColumns="repeat(2, 1fr)"}else if(!E){document.getElementById("appointmentTypesContainer").style.justifyContent="center"}if(await async function(){try{const e=await L("getSettings");e.success&&(i.APPOINTMENT_HOURS.interval=e.data.interval||60,i.MAX_DAILY_DELIVERY_APPOINTMENTS=e.data.maxDaily||4)}catch(e){}}(),E){if(await w(),"0"!==E){const e=p.find(e=>e.id==E);if(e){const t=document.getElementById("staffHeader");t.textContent=e.name,t.style.visibility="visible",r=parseInt(E)}}}else await w();document.getElementById("typeDelivery")?.addEventListener("click",()=>D("delivery")),document.getElementById("typeService")?.addEventListener("click",()=>D("service")),document.getElementById("typeMeeting")?.addEventListener("click",()=>D("meeting")),document.getElementById("typeManagement")?.addEventListener("click",()=>D("management")),document.getElementById("prevMonthBtn")?.addEventListener("click",()=>T(-1)),document.getElementById("nextMonthBtn")?.addEventListener("click",()=>T(1)),document.getElementById("calendarAppleBtn")?.addEventListener("click",x),document.getElementById("calendarGoogleBtn")?.addEventListener("click",x),document.getElementById("calendarOutlookBtn")?.addEventListener("click",x),document.getElementById("calendarICSBtn")?.addEventListener("click",x),document.getElementById("calendarModalCloseBtn")?.addEventListener("click",()=>o.close("calendarModal")),document.getElementById("guideCloseBtn")?.addEventListener("click",()=>o.close("guideModal"))}),document.getElementById("submitBtn")?.addEventListener("click",async function(){const e=document.getElementById("customerName").value.trim(),t=document.getElementById("customerPhone").value.trim(),n=document.getElementById("customerEmail").value.trim(),a=document.getElementById("customerNote").value.trim();if(!u)return void P("Lutfen randevu tipi secin.","error");if(!d||null==r||!c)return void P("Lutfen tarih, calisan ve saat secin.","error");if(!e||!t)return void P("Lutfen ad ve telefon bilgilerinizi girin.","error");if(!n)return void P("Lutfen e-posta adresinizi girin.","error");const l=document.getElementById("submitBtn");let o;l.disabled=!0,l.innerHTML='<span class="btn-spinner"></span> Randevu oluşturuluyor...';let s=null;if(0===r)o=window.managementContactPerson||"Yönetim";else{if(s=p.find(e=>e.id==r),!s)return P("Çalışan bilgisi bulunamadı. Lütfen sayfayı yenileyin.","error"),l.disabled=!1,void(l.textContent="Randevuyu Onayla");o=s.name}try{const p=await L("createAppointment",{date:d,time:c,staffId:r,staffName:o,customerName:e,customerPhone:t,customerEmail:n,customerNote:a,shiftType:m,appointmentType:u,duration:i.APPOINTMENT_HOURS.interval});p.success?(v={customerName:e,customerPhone:t,customerEmail:n,customerNote:a,staffName:o,staffPhone:s?.phone||"",staffEmail:s?.email||"",date:d,time:c,appointmentType:u,duration:i.APPOINTMENT_HOURS.interval},window.lastAppointmentData=v,function(e,t,n,a){const i=document.querySelector(".container");i.textContent="";const l=createSuccessPageSafe(e,t,n,a);i.appendChild(l),setTimeout(()=>{const e=document.getElementById("addToCalendarBtn");e&&e.addEventListener("click",k)},100)}(d,c,o,a)):(P("Randevu olusturulamadi: "+(p.error||"Bilinmeyen hata"),"error"),l.disabled=!1,l.textContent="Randevuyu Onayla")}catch(y){P("Randevu oluşturulamadı. Lütfen tekrar deneyiniz.","error"),l.disabled=!1,l.textContent="Randevuyu Onayla"}});
