ğŸ“‚ BÃ–LÃœM 1: INDEX
Sorun 1 â€” JSONP ile API Ã§aÄŸrÄ±sÄ± (callback + <script> enjeksiyonu)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: fetch + JSON + CORS ile tek sÃ¶zleÅŸmeli Ã§aÄŸrÄ± katmanÄ±.â€¨NasÄ±l YapÄ±lÄ±r:
	1	apiCall fonksiyonunu fetch(URLSearchParams) ile yeniden yaz.
	2	HTTP hata yÃ¶netimini if (!res.ok) throw Error(...) ÅŸeklinde standardize et.
	3	TÃ¼m Ã§aÄŸÄ±ran yerlerde eski JSONP akÄ±ÅŸÄ±nÄ± kaldÄ±r ve yeni apiCallâ€™a geÃ§ir.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–² (JSONP kaynaklÄ± riskler kapanÄ±r)
	â€¢	Modernizasyon: â–²â–² (standart web API, test edilebilirlik)
	â€¢	Performans: â–² (daha az DOM/script ekleme)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tek sÃ¶zleÅŸme, merkezi hata yÃ¶netimi)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ Orta (Ã§aÄŸÄ±ranlarÄ±n toplu gÃ¼ncellenmesi)

Sorun 2 â€” innerHTML ile metin/yapÄ± yazÄ±mÄ± (XSS yÃ¼zeyi)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: GÃ¼venli UI yardÄ±mcÄ±larÄ± (textContent tabanlÄ±) + gerekiyorsa sÄ±nÄ±rlÄ± DOMPurify.â€¨NasÄ±l YapÄ±lÄ±r:
	1	UI.alertSafe(message, type) ve basit renderListSafe(items) yardÄ±mcÄ±larÄ± yaz.
	2	TÃ¼m innerHTML = ... kullanÄ±mÄ±nÄ± bu yardÄ±mcÄ±larla deÄŸiÅŸtir; metinler textContent olarak set edilsin.
	3	Sadece gerÃ§ekten gerekli yerlerde, beyaz liste ile DOMPurify kullan.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–²â–² (XSS yÃ¼zeyi kapanÄ±r)
	â€¢	Modernizasyon: â–² (UI yardÄ±mcÄ±larÄ±)
	â€¢	Performans: â–  NÃ¶tr (Ã§oÄŸunlukla aynÄ±)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tekrarlÄ± ÅŸablonlar kalkar)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

Sorun 3 â€” ICS dosyasÄ±nÄ± front-endâ€™te Ã¼retme (TZ/format daÄŸÄ±nÄ±k)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: ICS Ã¼retimini Apps Scriptâ€™e taÅŸÄ±; front sadece indirir. TZ: Europe/Istanbul.â€¨NasÄ±l YapÄ±lÄ±r:
	1	Backendâ€™de generateICS(event) ve action=getICS ekle.
	2	Front: fetch('...action=getICS') â†’ Blob â†’ download.
	3	ICS alanlarÄ±: DTSTART/DTEND;TZID=Europe/Istanbul, UID, DTSTAMP.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–  NÃ¶tr
	â€¢	Modernizasyon: â–² (tek kaynak, tutarlÄ± format)
	â€¢	Performans: â–² (front daha az hesaplama/ÅŸablon)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (kopya kod kalkar)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

Sorun 4 â€” Ortama baÄŸlÄ± sabitlerin koda gÃ¶mÃ¼lÃ¼ olmasÄ± (URL vb.)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: env.js (gitignore) + config.js (genel) ile yapÄ±landÄ±rma dÄ±ÅŸsallaÅŸtÄ±rma.â€¨NasÄ±l YapÄ±lÄ±r:
	1	env.js iÃ§inde window.ENV = { APPS_SCRIPT_URL: "..." }.
	2	config.js â†’ const CONFIG = { APPS_SCRIPT_URL: window.ENV.APPS_SCRIPT_URL, TIMEZONE:'Europe/Istanbul' }.
	3	HTMLâ€™de her sayfaya Ã¶nce env.js, sonra config.js yÃ¼kle.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–² (gizli/deÄŸiÅŸken bilgi repodan Ã§Ä±kar)
	â€¢	Modernizasyon: â–²â–² (ortam yÃ¶netimi)
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (staging/prod geÃ§iÅŸi kolay)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

Sorun 5 â€” UA bazlÄ± platform tespiti (kÄ±rÄ±lgan akÄ±ÅŸ)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Ã–zellik tespiti (feature detection) ile akÄ±ÅŸ seÃ§imi.â€¨NasÄ±l YapÄ±lÄ±r:
	1	supportsDownload(), supportsWebShare(), supportsWebcal() gibi yardÄ±mcÄ± fonksiyonlar.
	2	Ä°ndirme / paylaÅŸma / webcal yollarÄ±nÄ± bu fonksiyonlarÄ±n sonuÃ§larÄ±na gÃ¶re seÃ§.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–  NÃ¶tr
	â€¢	Modernizasyon: â–² (kalÄ±cÄ± Ã§Ã¶zÃ¼m)
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–² (daha az â€œif UA.includesâ€¦â€)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

ğŸ“‚ BÃ–LÃœM 2: ADMIN
Sorun 1 â€” Adminâ€™de de JSONP kullanÄ±mÄ±
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Ortak apiCall (fetch+JSON) modÃ¼lÃ¼nÃ¼ adminâ€™de de kullan.â€¨NasÄ±l YapÄ±lÄ±r:
	1	src/shared/api.js (tek) dosyasÄ±nÄ± oluÅŸtur.
	2	Admin tarafÄ±ndaki tÃ¼m API Ã§aÄŸrÄ±larÄ±nÄ± bu modÃ¼le geÃ§ir.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–² (JSONP kalkar)
	â€¢	Modernizasyon: â–²â–²
	â€¢	Performans: â–²
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tek yerden yÃ¶netim)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ Orta (birÃ§ok Ã§aÄŸrÄ± deÄŸiÅŸecek)

Sorun 2 â€” Admin aksiyonlarÄ±nda yetkilendirme eksikliÄŸi
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Sunucu tarafÄ±nda ADMIN_API_KEY kontrolÃ¼ (kÄ±sa vadede).â€¨NasÄ±l YapÄ±lÄ±r:
	1	Apps Script ScriptProperties â†’ ADMIN_API_KEY sakla.
	2	Adminâ€™den gÃ¶nderilen tÃ¼m â€œyÃ¶netimâ€ isteklerine apiKey ekle.
	3	Backendâ€™de requireAdmin(e) guard: geÃ§ersiz anahtarda 401/403 JSON.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–²â–² (kritik)
	â€¢	Modernizasyon: â–² (standart auth deseni)
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–² (net sorumluluk)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼kâ€“Orta (istek imzalama eklenir)

Sorun 3 â€” innerHTML tabanlÄ± bildirimler / listelemeler
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Indexâ€™teki UI.alertSafe ve gÃ¼venli render yardÄ±mcÄ±larÄ±nÄ± ortaklaÅŸtÄ±r.â€¨NasÄ±l YapÄ±lÄ±r:
	1	src/shared/ui.js oluÅŸtur: alertSafe, renderListSafe.
	2	Adminâ€™deki innerHTML kullanan noktalarÄ± bu yardÄ±mcÄ±larla deÄŸiÅŸtir.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–²
	â€¢	Modernizasyon: â–²
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–²â–²
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

Sorun 4 â€” document.execCommand('copy') (deprecated)
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Asenkron Clipboard API (navigator.clipboard.writeText).â€¨NasÄ±l YapÄ±lÄ±r:
	1	copyText(text) yardÄ±mcÄ± fonksiyonu ekle.
	2	TÃ¼m â€œKopyalaâ€ butonlarÄ± bu yardÄ±mcÄ±yÄ± kullansÄ±n.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–² (izinli, tarayÄ±cÄ± modern API)
	â€¢	Modernizasyon: â–²â–²
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–² (tek yardÄ±mcÄ±)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k (HTTPS gerekliliÄŸine dikkat)

Sorun 5 â€” Tarih/hafta hesaplarÄ±nÄ±n tekrarlÄ± ve kÄ±rÄ±lgan olmasÄ±
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: utils/datetime.js altÄ±nda ISO hafta ve hafta baÅŸlangÄ±cÄ± yardÄ±mcÄ±larÄ±.â€¨NasÄ±l YapÄ±lÄ±r:
	1	getWeekStart(date), getISOWeek(date) fonksiyonlarÄ±nÄ± yaz.
	2	TÃ¼m manuel hesaplarÄ± bu fonksiyonlara yÃ¶nlendir.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–  NÃ¶tr
	â€¢	Modernizasyon: â–²
	â€¢	Performans: â–² (daha az karmaÅŸa/hata)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tek kaynak)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

ğŸ“‚ BÃ–LÃœM 3: APPS SCRIPT (Backend)
Sorun 1 â€” JSONP/callback ile yanÄ±t Ã¼retimi
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: doGet/doPost â†’ JSON yanÄ±t + CORS baÅŸlÄ±klarÄ±; JSONP kaldÄ±r.â€¨NasÄ±l YapÄ±lÄ±r:
	1	callback parametresi desteÄŸini kaldÄ±r.
	2	handleRequest(e, method) tek noktadan JSON dÃ¶ndÃ¼rsÃ¼n (ContentService + CORS).
	3	Hata yakalama: { success:false, error:"..." } ÅŸemasÄ±.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–²
	â€¢	Modernizasyon: â–²â–²
	â€¢	Performans: â–² (daha az metin birleÅŸtirme)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tek yanÄ±t katmanÄ±)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ Orta (front Ã¶nce gÃ¼ncellenmeli)

Sorun 2 â€” Admin aksiyonlarÄ±nda sunucu tarafÄ± yetki kontrolÃ¼ yok
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: requireAdmin(e) guard + ADMIN_ACTIONS kÃ¼mesi + 401/403.â€¨NasÄ±l YapÄ±lÄ±r:
	1	ADMIN_ACTIONS = new Set([...]) (add/remove/toggle/save).
	2	requireAdmin: if (ADMIN_ACTIONS.has(action) && e.parameter.apiKey !== ADMIN_API_KEY) throw...
	3	HatalarÄ± JSON olarak dÃ¶ndÃ¼r.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–²â–²â–²
	â€¢	Modernizasyon: â–²
	â€¢	Performans: â–  NÃ¶tr
	â€¢	BakÄ±m/Okunabilirlik: â–²
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k

Sorun 3 â€” ICS/e-posta ÅŸablonlarÄ± ve randevu tipleri daÄŸÄ±nÄ±k
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Tek enum+ÅŸablon kaynaÄŸÄ± (Ã¶rn. APPOINTMENT_TYPES, DISPLAY_NAMES, TEMPLATES).â€¨NasÄ±l YapÄ±lÄ±r:
	1	const APPOINTMENT_TYPES = {...} ve const DISPLAY_NAMES = {...} oluÅŸtur.
	2	sendCustomerMail(), notifyStaffAndAdmin() yardÄ±mcÄ±larÄ±yla e-posta/ICS metinlerini merkezileÅŸtir.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–  NÃ¶tr
	â€¢	Modernizasyon: â–² (tek yerden deÄŸiÅŸtirilebilir)
	â€¢	Performans: â–² (daha az tekrar/ÅŸablon Ã¼retimi)
	â€¢	BakÄ±m/Okunabilirlik: â–²â–² (tutarlÄ±lÄ±k)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼kâ€“Orta (metinlerde ufak uyarlamalar)

Sorun 4 â€” SÄ±k eriÅŸilen veriler iÃ§in kalÄ±cÄ±lÄ±k/cache yok
ğŸ† ÃœstÃ¼n Ã‡Ã¶zÃ¼m: Basit kalÄ±cÄ± cache (PropertiesService + TTL) yardÄ±mcÄ± sÄ±nÄ±fÄ±.â€¨NasÄ±l YapÄ±lÄ±r:
	1	PersistentCache.get(key, loader, ttlSecs) yaz.
	2	Personel listesi/ayarlar gibi sÄ±k okunan yerlere uygula.â€¨Mevcut Koda Etkisi:
	â€¢	GÃ¼venlik: â–  NÃ¶tr
	â€¢	Modernizasyon: â–²
	â€¢	Performans: â–²â–² (uzak okuma maliyeti dÃ¼ÅŸer)
	â€¢	BakÄ±m/Okunabilirlik: â–² (tek desen)
	â€¢	Kod YapÄ±sÄ± Riski: â—¼ï¸ DÃ¼ÅŸÃ¼k (TTL yanlÄ±ÅŸsa stale riskiâ€”kÄ±sa TTL ile baÅŸla)

ğŸ§© TÃ¼m SorunlarÄ±n TÃ¼m Ã‡Ã¶zÃ¼mlerle BÃ¼tÃ¼n Koda Etkisi (Ã–zet)
	â€¢	GÃ¼venlik: Ã‡ok YÃ¼ksek artÄ±ÅŸ
	â—¦	JSONPâ€™nin kaldÄ±rÄ±lmasÄ±, XSS yÃ¼zeylerinin kapatÄ±lmasÄ± ve admin iÃ§in server-side yetki kontrolÃ¼ kritik aÃ§Ä±klarÄ± kapatÄ±r.
	â€¢	Modernizasyon: YÃ¼ksek artÄ±ÅŸ
	â—¦	fetch/CORS, Clipboard API, config dÄ±ÅŸsallaÅŸtÄ±rma, ortak modÃ¼ller (api/ui/datetime) ile kod tabanÄ± gÃ¼ncel web standartlarÄ±na taÅŸÄ±nÄ±r.
	â€¢	Performans: Orta artÄ±ÅŸ
	â—¦	JSONPâ€™nin ve gereksiz DOM iÅŸlemlerinin kalkmasÄ±, ICSâ€™nin backendâ€™e taÅŸÄ±nmasÄ± ve kalÄ±cÄ± cache ile gÃ¶zle gÃ¶rÃ¼lÃ¼r iyileÅŸme.
	â€¢	BakÄ±m/Okunabilirlik: Ã‡ok YÃ¼ksek artÄ±ÅŸ
	â—¦	Tek sÃ¶zleÅŸmeli API, tek kaynaklÄ± ICS/ÅŸablonlar, yardÄ±mcÄ± modÃ¼ller ve ortam ayrÄ±mÄ±, deÄŸiÅŸikliklerin etkisini lokalize eder.
	â€¢	Kod YapÄ±sÄ± Riski (GeÃ§iÅŸ Riski): DÃ¼ÅŸÃ¼kâ€“Orta (yÃ¶netilebilir)
	â—¦	En bÃ¼yÃ¼k kÄ±rÄ±lÄ±m, Ã¶nce frontlarÄ±n fetch sÃ¶zleÅŸmesine geÃ§irilmesi, ardÄ±ndan backendâ€™in JSONPâ€™yi kapatmasÄ±yla yÃ¶netilir.
	â—¦	Ã–neri: Sprint sÄ±rasÄ± â†’ (1) Front fetch + XSS temizlik â†’ (2) Backend CORS/JSON â†’ (3) ICS/ÅŸablon konsolidasyonu â†’ (4) Cache + yardÄ±mcÄ±lar.


â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

ğŸ§­ Sprint 1 â€” GÃ¼venlik & AltyapÄ± (JSONP â†’ fetch, XSS, Admin Auth)
ğŸ« Kart 1.1 â€” JSONPâ€™yi KaldÄ±r, fetch + JSON + CORSâ€™a GeÃ§ (Index + Admin)
AmaÃ§: Tek sÃ¶zleÅŸmeli, gÃ¼venli ve test edilebilir Ã§aÄŸrÄ± katmanÄ±.
Etkilenen dosyalar
	â€¢	/mnt/data/index.html (tÃ¼m API Ã§aÄŸrÄ± yerleri)
	â€¢	/mnt/data/admin.html (tÃ¼m API Ã§aÄŸrÄ± yerleri)
	â€¢	yeni: src/shared/api.js (tek modÃ¼l)
	â€¢	/mnt/data/apps-script-backend.js (CORS baÅŸlÄ±klarÄ± + JSON yanÄ±t standardÄ±)
Ã–nerilen diff (iskelet)

--- a/index.html
+++ b/index.html
@@
- <!-- Eski: JSONP script injection ve callback adÄ± Ã¼retimi -->
- <script>/* apiCall via JSONP ... */</script>
+ <!-- Yeni: ortak API modÃ¼lÃ¼ -->
+ <script src="config.js"></script>
+ <script src="src/shared/api.js"></script>

--- a/admin.html
+++ b/admin.html
@@
- <script>/* admin JSONP apiCall */</script>
+ <script src="config.js"></script>
+ <script src="src/shared/api.js"></script>
+ <script>
+  // Ã¶rnek kullanÄ±m
+  api.get('listStaff').then(renderStaff)
+                     .catch(err => UI.alertSafe(err.message, 'error'));
+ </script>
Kod (src/shared/api.js)

// src/shared/api.js
const api = {
  async get(action, params = {}) {
    const url = new URL(CONFIG.APPS_SCRIPT_URL);
    url.searchParams.set('action', action);
    for (const [k, v] of Object.entries(params)) url.searchParams.set(k, v);
    const res = await fetch(url.toString(), { credentials: 'omit' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  },
  async post(action, body = {}) {
    const url = new URL(CONFIG.APPS_SCRIPT_URL);
    url.searchParams.set('action', action);
    const res = await fetch(url.toString(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      credentials: 'omit'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }
};
window.api = api;
Backend patch (CORS + JSON standardÄ±)

--- a/apps-script-backend.js
+++ b/apps-script-backend.js
@@
-function doGet(e){ /* JSONP callback mantÄ±ÄŸÄ± ... */ }
+function doGet(e){ return handleRequest(e, 'GET'); }
+function doPost(e){ return handleRequest(e, 'POST'); }
+
+function handleRequest(e, method){
+  try{
+    const payload = route(e, method);
+    return jsonOk(payload);
+  }catch(err){
+    return jsonOk({ success:false, error: String(err) }, 200);
+  }
+}
+
+function jsonOk(obj, status=200){
+  const out = ContentService.createTextOutput(JSON.stringify(obj))
+      .setMimeType(ContentService.MimeType.JSON);
+  out.setHeader('Access-Control-Allow-Origin','*');
+  out.setHeader('Access-Control-Allow-Methods','GET, POST, OPTIONS');
+  out.setHeader('Access-Control-Allow-Headers','Content-Type');
+  return out;
+}
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: feat(api): JSONPâ€™yi kaldÄ±r, fetch+JSON sÃ¶zleÅŸmesine geÃ§
	â€¢	Ã–zet: Frontâ€™ta ortak api.js; backendâ€™de handleRequest + CORS; tÃ¼m Ã§aÄŸrÄ±lar yeni sÃ¶zleÅŸmeye geÃ§irildi.
	â€¢	Test PlanÄ±: 200/4xx/5xx dÃ¶nÃ¼ÅŸleri; aÄŸ kesintisi simÃ¼lasyonu; admin ve index akÄ±ÅŸlarÄ±nÄ±n tÃ¼mÃ¼.
	â€¢	Rollback: api.js importâ€™u ve handleRequest Ã§aÄŸrÄ±larÄ± geri alÄ±nÄ±r; JSONP kodu restore.

ğŸ« Kart 1.2 â€” XSS Ã–nleme: innerHTML â†’ GÃ¼venli UI YardÄ±mcÄ±larÄ±
AmaÃ§: KullanÄ±cÄ± girdisi kaynaklÄ± XSS yÃ¼zeyini kapatmak.
Etkilenen dosyalar
	â€¢	/mnt/data/index.html
	â€¢	/mnt/data/admin.html
	â€¢	yeni: src/shared/ui.js
Ã–nerilen diff

--- a/index.html
+++ b/index.html
@@
- container.innerHTML = "<div class='alert'>" + msg + "</div>";
+ UI.alertSafe(msg, 'info');

--- a/admin.html
+++ b/admin.html
@@
- listEl.innerHTML = items.map(x => `<li>${x.name}</li>`).join('');
+ UI.renderListSafe(listEl, items.map(x => x.name));
Kod (src/shared/ui.js)

// src/shared/ui.js
const UI = {
  alertSafe(message, type='info') {
    const c = document.getElementById('alertContainer') || document.body;
    const box = document.createElement('div');
    box.className = `alert alert-${type}`;
    box.textContent = String(message ?? '');
    c.appendChild(box);
    setTimeout(()=> box.remove(), 4000);
  },
  renderListSafe(ul, texts=[]) {
    ul.textContent = '';
    for (const t of texts){
      const li = document.createElement('li');
      li.textContent = String(t ?? '');
      ul.appendChild(li);
    }
  }
};
window.UI = UI;
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: fix(xss): innerHTML kullanÄ±mÄ±nÄ± gÃ¼venli yardÄ±mcÄ±larla deÄŸiÅŸtir
	â€¢	Ã–zet: alertSafe, renderListSafe eklendi; yÃ¼zeysel XSS noktalarÄ± temizlendi.
	â€¢	Test PlanÄ±: <img onerror=alert(1)>, <script> payloadâ€™larÄ± etkisiz.
	â€¢	Rollback: UI yardÄ±mcÄ±larÄ± devre dÄ±ÅŸÄ±; Ã¶nceki innerHTML satÄ±rlarÄ± geri alÄ±nÄ±r.

ğŸ« Kart 1.3 â€” Admin Yetkilendirme (API Key, kÄ±sa vade)
AmaÃ§: YÃ¶netim aksiyonlarÄ±nÄ± yetkisiz kullanÄ±ma kapatmak.
Etkilenen dosyalar
	â€¢	/mnt/data/apps-script-backend.js
	â€¢	/mnt/data/admin.html (isteklere apiKey ekleme)
Backend patch

--- a/apps-script-backend.js
+++ b/apps-script-backend.js
@@
+const ADMIN_ACTIONS = new Set(['addStaff','removeStaff','toggleStaff','saveShifts','saveSettings']);
+const ADMIN_API_KEY = PropertiesService.getScriptProperties().getProperty('ADMIN_API_KEY');
+
+function requireAdmin(e){
+  const action = e.parameter.action;
+  if (ADMIN_ACTIONS.has(action)){
+    if (e.parameter.apiKey !== ADMIN_API_KEY) throw new Error('Unauthorized');
+  }
+}
 
 function handleRequest(e, method){
   try{
+    requireAdmin(e);
     const payload = route(e, method);
     return jsonOk(payload);
   }catch(err){
     return jsonOk({ success:false, error: String(err) }, 200);
   }
 }
Admin tarafÄ± (Ã¶rnek Ã§aÄŸrÄ±)

// admin.html (kullanÄ±m)
api.post('saveSettings', { ... , apiKey: CONFIG.ADMIN_API_KEY })
   .then(()=> UI.alertSafe('Ayarlar kaydedildi','success'))
   .catch(err => UI.alertSafe(err.message,'error'));
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: feat(admin-auth): yÃ¶netim aksiyonlarÄ± iÃ§in API key kontrolÃ¼
	â€¢	Ã–zet: requireAdmin guard; ScriptPropertiesâ€™te ADMIN_API_KEY.
	â€¢	Test PlanÄ±: keyâ€™siz istek 401/403; doÄŸru anahtarda baÅŸarÄ±.
	â€¢	Rollback: requireAdmin Ã§aÄŸrÄ±sÄ± ve kontrol satÄ±rlarÄ± geri alÄ±nÄ±r.

ğŸ§­ Sprint 2 â€” Mimari Temizlik (ICS tek kaynak, Config dÄ±ÅŸsallaÅŸtÄ±rma)
ğŸ« Kart 2.1 â€” ICS Ãœretimini Backendâ€™e TaÅŸÄ± (Index/Admin indirsin)
AmaÃ§: Tek kaynaktan doÄŸru ICS; kopya kod temizliÄŸi.
Etkilenen dosyalar
	â€¢	/mnt/data/apps-script-backend.js (yeni endpoint)
	â€¢	/mnt/data/index.html (indirme akÄ±ÅŸÄ±)
	â€¢	/mnt/data/admin.html (gerekliyse indirme akÄ±ÅŸÄ±)
Backend: ICS endpoint

--- a/apps-script-backend.js
+++ b/apps-script-backend.js
@@
+function route(e, method){
+  const action = e.parameter.action;
+  if (action === 'getICS') return { ics: generateICS(extractEvent(e)) };
+  // ...diÄŸer actionlar...
+}
+
+function generateICS(evt){
+  const lines = [
+    'BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN',
+    'BEGIN:VEVENT',
+    `UID:${evt.uid}`,
+    `DTSTAMP:${evt.dtstamp}Z`,
+    `DTSTART;TZID=Europe/Istanbul:${evt.dtstart}`,
+    `DTEND;TZID=Europe/Istanbul:${evt.dtend}`,
+    `SUMMARY:${evt.summary}`,
+    `DESCRIPTION:${evt.description}`,
+    'END:VEVENT','END:VCALENDAR'
+  ];
+  return lines.join('\r\n');
+}
Frontend: indirme akÄ±ÅŸÄ±

// index.html
async function downloadICS(params){
  const { ics } = await api.get('getICS', params);
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'event.ics';
  document.body.appendChild(a); a.click(); a.remove();
}
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: refactor(ics): ICS Ã¼retimini backendâ€™e taÅŸÄ±, front yalnÄ±z indir
	â€¢	Ã–zet: getICS action; TZ Europe/Istanbul; frontâ€™ta blob indirme.
	â€¢	Test PlanÄ±: iOS/Android/Outlook/GCalâ€™da saat doÄŸruluÄŸu.
	â€¢	Rollback: generateICS ve getICS kaldÄ±rÄ±lÄ±r; eski front ÅŸablonu geri.

ğŸ« Kart 2.2 â€” KonfigÃ¼rasyon DÄ±ÅŸsallaÅŸtÄ±rma (env.js + config.js)
AmaÃ§: Ortam bazlÄ± deÄŸerler repo dÄ±ÅŸÄ±na.
Etkilenen dosyalar
	â€¢	yeni: env.js (gitignore)
	â€¢	yeni: config.js
	â€¢	/mnt/data/index.html, /mnt/data/admin.html (script ekleme)
Dosyalar

// env.js (gitignore)
window.ENV = {
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/XXXX/exec",
  ADMIN_API_KEY: "set-me-on-deploy"
};

// config.js
const CONFIG = {
  APPS_SCRIPT_URL: window.ENV.APPS_SCRIPT_URL,
  ADMIN_API_KEY: window.ENV.ADMIN_API_KEY,
  TIMEZONE: 'Europe/Istanbul'
};
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: chore(config): env.js + config.js ile ortam yÃ¶netimi
	â€¢	Ã–zet: URL/anahtarlar koddan Ã§Ä±ktÄ±; staging/prod kolaylaÅŸtÄ±.
	â€¢	Test PlanÄ±: env deÄŸiÅŸimiyle sÄ±fÄ±r kod deÄŸiÅŸiklik.
	â€¢	Rollback: script ekleri ve CONFIG kullanÄ±mÄ± geri alÄ±nÄ±r.

ğŸ§­ Sprint 3 â€” UX/DX Modernizasyonu
ğŸ« Kart 3.1 â€” Clipboard APIâ€™ye GeÃ§iÅŸ
AmaÃ§: execCommand('copy') yerine modern API.
Etkilenen dosyalar
	â€¢	/mnt/data/admin.html
	â€¢	yeni/ortak: src/shared/ui.js (kopyalama yardÄ±mcÄ±si)
Kod

--- a/src/shared/ui.js
+++ b/src/shared/ui.js
@@
+UI.copyText = async function(text){
+  try{
+    await navigator.clipboard.writeText(String(text ?? ''));
+    UI.alertSafe('KopyalandÄ±','success');
+  }catch{
+    UI.alertSafe('KopyalanamadÄ±','error');
+  }
+};
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: feat(clipboard): execCommand yerine Clipboard API
	â€¢	Ã–zet: TÃ¼m kopyalama butonlarÄ± UI.copyText kullanÄ±yor.
	â€¢	Test PlanÄ±: HTTPS ortamÄ±nda kopyalama baÅŸarÄ±lÄ±.
	â€¢	Rollback: UI.copyText yerine eski fonksiyonlar restore.

ğŸ« Kart 3.2 â€” Feature Detection ile AkÄ±ÅŸ SeÃ§imi (UA Parsingi KaldÄ±r)
AmaÃ§: DayanÄ±klÄ± platform davranÄ±ÅŸÄ±.
Etkilenen dosyalar
	â€¢	/mnt/data/index.html (download/share/webcal akÄ±ÅŸÄ±)
	â€¢	yeni: src/shared/features.js
Kod (src/shared/features.js)

const Features = {
  supportsDownload(){ try{ return 'download' in document.createElement('a'); }catch{ return false; } },
  supportsShare(){ return !!(navigator.share); },
  supportsClipboard(){ return !!(navigator.clipboard && navigator.clipboard.writeText); },
  // webcal desteÄŸi tarayÄ±cÄ±ya gÃ¶re deÄŸiÅŸir; iOS Safari iÃ§in tespit akÄ±ÅŸÄ±:
  isLikelyIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }
};
window.Features = Features;
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: refactor(feature-detect): UA yerine Ã¶zellik tespiti
	â€¢	Ã–zet: Ä°ndirme/paylaÅŸÄ±m/webcal kararlarÄ± Ã¶zellik bazlÄ±.
	â€¢	Test PlanÄ±: iOS Safari / Android Chrome / Desktop tarayÄ±cÄ±larÄ±.
	â€¢	Rollback: Ã§aÄŸrÄ±lar eski koÅŸullara alÄ±nÄ±r.

ğŸ« Kart 3.3 â€” Tarih/Hafta YardÄ±mcÄ±larÄ± (ISO Week)
AmaÃ§: TekrarlÄ±, kÄ±rÄ±lgan tarih hesaplarÄ±nÄ± merkezileÅŸtir.
Etkilenen dosyalar
	â€¢	/mnt/data/admin.html
	â€¢	yeni: src/shared/datetime.js
Kod (src/shared/datetime.js)

export function getWeekStart(d){
  const tmp = new Date(d); const day = tmp.getDay() || 7;
  if(day !== 1) tmp.setDate(tmp.getDate() - (day - 1));
  return new Date(tmp.getFullYear(), tmp.getMonth(), tmp.getDate());
}
export function getISOWeek(d){
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7; tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
  return Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
}
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: refactor(datetime): ISO hafta/hafta baÅŸÄ± yardÄ±mcÄ±larÄ±
	â€¢	Ã–zet: TÃ¼m manuel hesaplar datetime.jsâ€™e taÅŸÄ±ndÄ±.
	â€¢	Test PlanÄ±: 1/52/53. haftalar iÃ§in Ã¶rnek veri doÄŸrulama.
	â€¢	Rollback: fonksiyon referanslarÄ± eski hesaplamalara dÃ¶nÃ¼lÃ¼r.

ğŸ§­ Sprint 4 â€” Verimlilik & Ä°Ã§erik Konsolidasyonu
ğŸ« Kart 4.1 â€” Basit KalÄ±cÄ± Cache (PropertiesService + TTL)
AmaÃ§: SÄ±k okunan verilerde gecikme/maliyet dÃ¼ÅŸÃ¼rmek.
Etkilenen dosyalar
	â€¢	/mnt/data/apps-script-backend.js (cache sÄ±nÄ±fÄ± + kullanÄ±m noktalarÄ±)
Kod (Apps Script)

function PersistentCache(ttlSecs){ this.ttl = ttlSecs || 300; }
PersistentCache.prototype.get = function(key, loader){
  const ps = PropertiesService.getScriptProperties();
  const meta = JSON.parse(ps.getProperty('__CACHE_META__') || '{}');
  const now = Date.now();
  if (meta[key] && meta[key].exp > now) {
    return JSON.parse(ps.getProperty(`CACHE_${key}`));
  }
  const val = loader();
  ps.setProperty(`CACHE_${key}`, JSON.stringify(val));
  meta[key] = { exp: now + this.ttl*1000 };
  ps.setProperty('__CACHE_META__', JSON.stringify(meta));
  return val;
};
KullanÄ±m Ã¶rneÄŸi

const cache = new PersistentCache(300);
function getStaffList(){
  return cache.get('staff', () => {
    // pahalÄ± okuma...
    return readStaffFromSheet();
  });
}
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: feat(cache): PropertiesService tabanlÄ± TTL cache
	â€¢	Ã–zet: Staff/ayar okuma maliyeti dÃ¼ÅŸer, 2. Ã§aÄŸrÄ±lar hÄ±zlanÄ±r.
	â€¢	Test PlanÄ±: Ä°lk/ikinci Ã§aÄŸrÄ± latency kÄ±yas, TTL sonrasÄ± yenileme.
	â€¢	Rollback: cache sÄ±nÄ±fÄ± ve Ã§aÄŸrÄ±larÄ± kaldÄ±rÄ±lÄ±r, doÄŸrudan okuma.

ğŸ« Kart 4.2 â€” E-posta/ICS Åablon Konsolidasyonu
AmaÃ§: Tek enum/ÅŸablon kaynaÄŸÄ±; tutarlÄ± metinler.
Etkilenen dosyalar
	â€¢	/mnt/data/apps-script-backend.js (ÅŸablon modÃ¼lÃ¼ + kullanÄ±m)
Kod

const APPOINTMENT_TYPES = { consultation:'consultation', meeting:'meeting' };
const DISPLAY_NAMES = { consultation:'DanÄ±ÅŸmanlÄ±k', meeting:'ToplantÄ±' };
const TEMPLATES = {
  customerSubject: (t)=> `Randevu: ${DISPLAY_NAMES[t]}`,
  customerBody: (evt)=> `Merhaba...\nTarih: ${evt.date}\nSaat: ${evt.time}\n...`,
  staffBody: (evt)=> `Yeni etkinlik: ${evt.summary}\n...`
};

function sendCustomerMail(evt){
  const subject = TEMPLATES.customerSubject(evt.type);
  const body = TEMPLATES.customerBody(evt);
  // MailApp.sendEmail(...subject, body...)
}
PR TaslaÄŸÄ±
	â€¢	BaÅŸlÄ±k: refactor(templates): e-posta/ICS metinleri tek modÃ¼lde
	â€¢	Ã–zet: AdlandÄ±rmalar ve metinler tek yerden yÃ¶netiliyor.
	â€¢	Test PlanÄ±: Her randevu tipinde doÄŸru konu/gÃ¶vde; alan uyuÅŸmazlÄ±ÄŸÄ± yok.
	â€¢	Rollback: tek modÃ¼l kaldÄ±rÄ±lÄ±p Ã¶nceki metinler restore edilir.

ğŸ§© TÃ¼m SorunlarÄ±n TÃ¼m Ã‡Ã¶zÃ¼mlerle BÃ¼tÃ¼n Koda Etkisi (Toplam Etki Ã–zeti)
	â€¢	GÃ¼venlik: Ã‡ok yÃ¼ksek artÄ±ÅŸ
	â—¦	JSONPâ€™nin kaldÄ±rÄ±lmasÄ±, XSS yÃ¼zeyinin kapanmasÄ±, admin aksiyonlarÄ±nÄ±n yetkilendirilmesi.
	â€¢	Modernizasyon: YÃ¼ksek artÄ±ÅŸ
	â—¦	fetch/CORS, Clipboard API, feature detection, env/config ayrÄ±mÄ±, ortak modÃ¼ller (api/ui/datetime).
	â€¢	Performans: Orta+ artÄ±ÅŸ
	â—¦	Script enjeksiyonunun kalkmasÄ±, ICSâ€™nin backendâ€™e taÅŸÄ±nmasÄ±, persistent cache ile sÄ±cak Ã§aÄŸrÄ±larda hÄ±zlanma.
	â€¢	BakÄ±m/Okunabilirlik: Ã‡ok yÃ¼ksek artÄ±ÅŸ
	â—¦	Tek sÃ¶zleÅŸme, tek ÅŸablon/ICS kaynaÄŸÄ±, yardÄ±mcÄ± modÃ¼ller ve ortam yÃ¶netimi sayesinde deÄŸiÅŸiklikler lokalize.
	â€¢	Kod YapÄ±sÄ± Riski (GeÃ§iÅŸ): DÃ¼ÅŸÃ¼kâ€“Orta, yÃ¶netilebilir
	â—¦	En kritik baÄŸÄ±mlÄ±lÄ±k: frontâ€™lar Ã¶nce api.jsâ€™e geÃ§irilir â†’ backend JSONP kaldÄ±rÄ±lÄ±r â†’ ICS/ÅŸablonlar konsolide edilir â†’ cache/yardÄ±mcÄ±lar devreye alÄ±nÄ±r.
